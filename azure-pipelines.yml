trigger:
  branches:
    include:
      - main  # Adjust as needed

jobs:
- job: Android_Testing
  pool:
    vmImage: 'ubuntu-latest'

  steps:
  - checkout: self
    displayName: 'Checkout Repository'

  - script: |
      echo "Installing Flutter (Latest Stable Version)..."

      # Clone the latest stable version of Flutter
      git clone https://github.com/flutter/flutter.git --branch stable --depth 1 ~/flutter

      # Add Flutter to PATH
      export PATH="$HOME/flutter/bin:$PATH"
      echo "##vso[task.setvariable variable=FLUTTER_HOME]$HOME/flutter"
      echo "##vso[task.setvariable variable=PATH]$HOME/flutter/bin:$PATH"

      # Verify installation
      if ! ~/flutter/bin/flutter --version; then
        echo "Flutter installation failed"
        exit 1
      fi

      # Debugging info
      echo "Flutter SDK installed at: $HOME/flutter"
      echo "Current PATH: $PATH"

      # Run Flutter Doctor to check setup
      flutter doctor
    displayName: 'Install Latest Flutter'

  - script: |
      cd myflutterapp  # Ensure correct project directory
      flutter pub get
    displayName: 'Install Dependencies'

  - script: |
      cd myflutterapp
      flutter analyze
    displayName: 'Run Flutter Analyze'

  - script: |
      cd myflutterapp
      flutter test test/ --machine > test-results.json
    displayName: 'Run Widget Tests'

  - script: |
      sudo apt-get update -y
      sudo apt-get install -y libglu1-mesa
    displayName: 'Install Dependencies for Emulator'

  - script: |
      echo "Starting Android Emulator..."
      $ANDROID_HOME/emulator/emulator -avd test_emulator -no-audio -no-window -no-snapshot &
      adb wait-for-device
      adb devices
    displayName: 'Start Android Emulator'

  - script: |
      cd myflutterapp
      flutter test integration_test/ --machine > integration-test-results.json
    displayName: 'Run Android Integration Tests'

  - script: |
      dart pub global activate junitreport
      cat myflutterapp/test-results.json | tojunit > myflutterapp/test-results.xml
      cat myflutterapp/integration-test-results.json | tojunit > myflutterapp/integration-test-results.xml
    displayName: 'Convert Test Results to JUnit Format'

  - task: PublishTestResults@2
    inputs:
      testResultsFiles: '**/test-results.xml'
      testResultsFormat: 'JUnit'
      mergeTestResults: true
    displayName: 'Publish Android Test Results'

  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: 'myflutterapp/test-results.xml'
      artifactName: 'android-test-results'
    displayName: 'Upload Android Test Results Artifact'

- job: iOS_Testing
  pool:
    vmImage: 'macOS-latest'
  dependsOn: Android_Testing

  steps:
  - checkout: self
    displayName: 'Checkout Repository'

  - script: |
      echo "Installing Flutter (Stable)..."
      git clone https://github.com/flutter/flutter.git --branch stable --depth 1
      export FLUTTER_HOME=$(pwd)/flutter
      export PATH="$FLUTTER_HOME/bin:$PATH"
      echo "##vso[task.setvariable variable=FLUTTER_HOME]$FLUTTER_HOME"
      echo "##vso[task.setvariable variable=PATH]$FLUTTER_HOME/bin:$PATH"
      cd flutter
      git fetch --unshallow
      git pull origin stable
      flutter doctor
      flutter --version
    displayName: 'Install Flutter (Stable) & Verify'

  - script: |
      cd myflutterapp
      flutter pub get
    displayName: 'Install Dependencies'

  - script: |
      cd myflutterapp
      flutter analyze
    displayName: 'Run Flutter Analyze'

  - script: |
      cd myflutterapp
      flutter test test/ --machine > test-results.json
    displayName: 'Run Widget Tests'

  - script: |
      echo "Starting iOS Simulator..."
      xcrun simctl boot "iPhone 14"
      xcrun simctl list devices
    displayName: 'Start iOS Simulator'

  - script: |
      cd myflutterapp
      flutter test integration_test/ --machine > integration-test-results.json
    displayName: 'Run iOS Integration Tests'

  - script: |
      dart pub global activate junitreport
      cat myflutterapp/test-results.json | tojunit > myflutterapp/test-results.xml
      cat myflutterapp/integration-test-results.json | tojunit > myflutterapp/integration-test-results.xml
    displayName: 'Convert Test Results to JUnit Format'

  - task: PublishTestResults@2
    inputs:
      testResultsFiles: '**/test-results.xml'
      testResultsFormat: 'JUnit'
      mergeTestResults: true
    displayName: 'Publish iOS Test Results'

  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: 'myflutterapp/test-results.xml'
      artifactName: 'ios-test-results'
    displayName: 'Upload iOS Test Results Artifact'